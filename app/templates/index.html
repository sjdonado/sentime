{% extends "layout.html" %}

{% block content %}
  <h1>{{ title }}</h1>
  Text <input id="text" type="text" value="{{ text }}">
  <button onclick="search()">Search</button>
  <script type="text/javascript" charset="utf-8">
    const socket = io();

    function search() {
      const table = document.getElementById('progress-table');
      document.getElementById('progress').innerText = 'Progress: 0%'
      while (table.rows.length > 1) {
        table.deleteRow(table.rows.length - 1);
      }
      socket.emit('search', JSON.stringify({ text: document.getElementById('text').value }));
    }

    let resultsCounter = 0;
    let tweets_acum = 0;
    let heatmapData = [];

    socket.on('tweets', function ({ status, data }) {
      console.log('status => ', status, 'data => ', data);
      if (status === 'processing') {
        const { city, tweets } = data;

        resultsCounter += 1;
        tweets_acum += tweets.length;
        document.getElementById('progress').innerText = `Progress: ${(resultsCounter / 32) * 100}%`;

        const table = document.getElementById('progress-table');
        const row = table.insertRow(table.rows.length);
        const cityCell = row.insertCell(0);
        const resultsCell = row.insertCell(1);
        const acumCell = row.insertCell(2);
        cityCell.innerHTML = city.formatted_address;
        resultsCell.innerHTML = tweets.length;
        acumCell.innerHTML = tweets_acum;

        console.log('tweets =>', tweets);

        heatmapData.push({
          location: new google.maps.LatLng(Number(city.geometry.location.lat), Number(city.geometry.location.lng)),
          weight: tweets.length
        });
      }
      if (status === 'finished') {
        var heatmap = new google.maps.visualization.HeatmapLayer({
          data: heatmapData,
          radius: 20,
        });
        heatmap.setMap(map);
        
        resultsCounter = 0;
        tweets_acum = 0;
        heatmapData = [];
      }
    });
  </script>
{% endblock %}

{% block map %}
<div id="map"></div>
<script>
  map = new google.maps.Map(document.getElementById('map'), {
    center: {lat: 4.1156735, lng: -72.9301367},
    zoom: 5,
  });
</script>

{% endblock %}