{% extends "layout.html" %}

{% block content %}
  <h1>{{ title }}</h1>
  Text <input id="text" type="text" value="{{ text }}">
  <button onclick="search()">Search</button>
  <script type="text/javascript" charset="utf-8">
    const socket = io();

    function search() {
      socket.emit('search', JSON.stringify({ text: document.getElementById('text').value }));
    }

    socket.on('tweets', function ({ status, data }) {
      console.log('status => ', status, 'data => ', data);
      if (status === 'processing') {
        console.log('tweets =>', data.tweets)
        // document.getElementById('progress').innerText = `Completado: ${progress * 100}%`;
        const table = document.getElementById('progress-table');
        const row = table.insertRow(table.rows.length - 1);
        const cityCell = row.insertCell(0);
        const resultsCell = row.insertCell(1);
        cityCell.innerHTML = data.city.formatted_address;
        resultsCell.innerHTML = data.tweets.length;
      }
      if (status === 'finished') {
        // const dataPoints = data.map(({ city }) => [Number(city.geometry.location.lat), Number(city.geometry.location.lng), 1]);
        // console.log('dataPoints', dataPoints);
  
        // heatmap.setData( dataPoints );
        // mymap.addLayer(heatmap);
      }
    });
  </script>
{% endblock %}

{% block map %}
<script>
  var mymap = L.map('mapid');

  L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
    attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
    maxZoom: 18,
    id: 'mapbox/streets-v11',
    accessToken: '{{ access_token }}',
  }).addTo(mymap);

  var heatmap = L.webGLHeatmap({ size: 1000 }); 

  mymap.setView([4.5709, 4.5709], 12.5);
</script>

{% endblock %}